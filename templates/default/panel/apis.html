{% extends "layout.html" %}

{% from "macros/form_inputs.html" import
    input_csrf_token
    with context
    %}

{% from "macros/general.html" import
    show_pages,
    show_event_name
    with context
    %}

{% from "macros/msg_handlers.html" import log_msg_handler with context %}

{% block title %}{{ _('API Panel') }}{% endblock %}
{% block navlinks_api_panel %}class="active"{% endblock %}

{% block main %}

{{ log_msg_handler(msg) }}
<style>
    /* The Modal (background) */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1; /* Sit on top */
      padding-top: 200px; /* Location of the box */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    
    /* Modal Content */
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
    
    /* The Close Button */
    .close {
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .keybox {
        max-width: 400px !important;
        word-wrap: break-word !important;
    }
</style>
<script>
    function addKey(e){
        if(e.checked){
            var p = e.parentElement.parentElement;
            var ip = p.children[3].innerText;
            var ne = document.createElement('input');
            ne.type = "hidden";
            ne.name="key";
            ne.id="key_"+e.value;
            ne.value = ip;
            p.firstElementChild.appendChild(ne);
        }
        else{
            document.getElementById('key_'+e.value).remove();
        }
    }
</script>
<div class="content-box">
    <div class="box-body" style="width: 110% !important;">
        <div class="box-header clear">
            <ul class="tabs clear">
                <li><input type="button" class="apidoc_button" onclick='var p=document.getElementById("apidoc");if(p.style.display=="none"){p.style.display="block";var cl=this.className;var ele=document.getElementsByClassName(cl);for(var i=0;i<ele.length;i++){ele[i].value="Hide Doc";p.scrollIntoView();}}else{p.style.display="none";var cl=this.className;var ele=document.getElementsByClassName(cl);for(var i=0;i<ele.length;i++){ele[i].value="Show Doc"}}' class="button fl-space" value="Show Doc" /></li>
                <li><a href="{{ctx.homepath}}/apis/generate"><i class="fa fa-plus"></i> {{ _('Generate API Keys') }}</a></li>
            </ul>
            <h2>{{ _('APIs Panel') }}
                {% if total > 0 %}
                    ({{ (cur_page-1)*page_size_limit + 1 }}-{{ (cur_page-1)*page_size_limit + (entries |length) }}/{{ total }})
                {% endif %}
            </h2>
        </div>

<div class="clear"></div>

{# List all API Keys #}
<form name="keys" id="list_table" method="post" action="{{ctx.homepath}}/apis">
    {{ input_csrf_token() }}
    <table class="style1">
        <thead>
            <tr>
                <th class="checkbox"><input type="checkbox" id="select-all-checkbox" class="checkbox select-all" /></th>
                <th data-sort="string-ins">{{ _('Creation Time') }}</th>
                <th data-sort="string-ins">{{ _('Generated By') }}</th>
                <th data-sort="string-ins" class="keybox">{{ _('Key') }}</th>
                <th data-sort="string-ins">{{ _('Expiry DateTime') }}</th>
                <th data-sort="string-ins">{{ _('Is Enabled?') }}</th>
                <th data-sort="string-ins">{{ _('Is Global Admin Key?') }}</th>
            </tr>
        </thead>

        {# List Keys. #}
        <tbody>
            {% if entries |length > 0 %}
                {% for key in entries %}
                    <tr>
                        <td class="checkbox"><input type="checkbox" onchange="addKey(this)" name="id" value="{{ key.kid }}" class="checkbox" /></td>
                        <td style="white-space: nowrap;">{{ key.creation_timestamp |set_datetime_format | utc_to_timezone(timezone=session['timezone'])}}</td>
                        <td>{{ key.generated_by |e }}</td>
                        <td><div class="keybox">{{ key.api_key |e }}</div></td>
                        <td>{{ key.expiry_date_time |e }}</td>
                        <td>
                            {% if key.is_enabled == 1 %}
                                <p>Yes</p>
                            {% elif key.is_enabled == 0 %}
                                <p>No</p>
                            {% else %}
                                {{ key.is_enabled |e }}
                            {% endif %}
                        </td>
                        <td>
                            {% if key.isglobaladminapi == 1 %}
                                <p>Yes</p>
                            {% elif key.isglobaladminapi == 0 %}
                                <p>No</p>
                            {% else %}
                                {{ key.isglobaladminapi |e }}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                        <td class="checkbox"></td>
                    <td colspan="6">{{ _('No API Keys generated yet.') }}</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
    {% if entries |length > 0 %}
    <div class="tab-footer clear f1">
            <div class="fl">
                <select name="action" class="fl-space">
                    <option>{{ _('Choose Action') }}</option>
                    <option disabled>----</option>
                    <option value="delete">{{ _('Disable selected') }}</option>
                    <option value="deleteAll">{{ _('Disable all in database') }}</option>
                </select>
                <input type="submit" value="{{ _('Apply') }}" class="button fl-space" />
            </div>
        

        {{ show_pages(baseurl=ctx.homepath + '/apis?',
                      total=total,
                      cur_page=cur_page,
                      sep='&page=') }}
    </div>
    {% endif %}
</form>
</div>
<div id="apidoc" style="display: none;min-height: 1500px;">
    <input type="button" class="apidoc_button" onclick='var p=document.getElementById("apidoc");if(p.style.display=="none"){p.style.display="block";var cl=this.className;var ele=document.getElementsByClassName(cl);for(var i=0;i<ele.length;i++){ele[i].value="Hide Doc";p.scrollIntoView();}}else{p.style.display="none";var cl=this.className;var ele=document.getElementsByClassName(cl);for(var i=0;i<ele.length;i++){ele[i].value="Show Doc"}}' class="button fl-space" value="Show Doc" />
    <object data="{{ctx.homepath}}/static/iRedAdmin_API_Doc.pdf" type="application/pdf" width="100%" height="1500px">
        <p></p><a href="{{ctx.homepath}}/static/iRedAdmin_API_Doc.pdf">Download the API Doc PDF!</a></p>
    </object>
    <input type="button" class="apidoc_button" onclick='var p=document.getElementById("apidoc");if(p.style.display=="none"){p.style.display="block";var cl=this.className;var ele=document.getElementsByClassName(cl);for(var i=0;i<ele.length;i++){ele[i].value="Hide Doc";p.scrollIntoView();}}else{p.style.display="none";var cl=this.className;var ele=document.getElementsByClassName(cl);for(var i=0;i<ele.length;i++){ele[i].value="Show Doc"}}' class="button fl-space" value="Show Doc" />
</div>
</div>
{% endblock main %}
